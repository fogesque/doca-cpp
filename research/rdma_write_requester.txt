Config 
============
Peers: 
    WriteRequester -> WriteResponder

Connections:
    CM
====================================


[open_device]
DEV_LIST = doca_devinfo_create_list()
for dev_ib_name != input_ib_name {
    dev_ib_name = doca_devinfo_get_ibdev_name(DEV_LIST[i])
    DEVICE = doca_dev_open(DEV_LIST[i])
}
doca_devinfo_destroy_list(DEV_LIST)

LOCAL_MEMRANGE = calloc()    // 4096 bytes

[create_local_mmap]
LOCAL_MMAP = doca_mmap_create()
doca_mmap_set_permissions(LOCAL_MMAP, DOCA_ACCESS_FLAG_LOCAL_READ_WRITE)
doca_mmap_set_memrange(LOCAL_MMAP, LOCAL_MEMRANGE)
doca_mmap_add_dev(LOCAL_MMAP, DEVICE)
doca_mmap_start(LOCAL_MMAP)

PE = doca_pe_create()

RDMA = doca_rdma_create(DEVICE)
RDMA_CTX = doca_rdma_as_ctx(RDMA)
doca_rdma_set_permissions(RDMA, DOCA_ACCESS_FLAG_LOCAL_READ_WRITE)
doca_rdma_set_gid_index(RDMA)
doca_rdma_set_max_num_connections(RDMA, NUM_CONNECTIONS)
doca_rdma_set_transport_type(RDMA, RC)

doca_pe_connect_ctx(PE, RDMA_CTX)


doca_rdma_task_write_set_conf(RDMA, func{rdma_write_requester_completed_callback} func{rdma_write_requester_error_callback})
    
    rdma_write_requester_completed_callback(TASK_WRITE, TASK_USER_DATA, CTX_USER_DATA):

        ALL = CTX_USER_DATA
        ERROR = TASK_USER_DATA
        RDMA_TASK = doca_rdma_task_send_as_task(TASK_WRITE)
        doca_task_free(RDMA_TASK)
        doca_buf_dec_refcount(ALL::DEST_BUF)
        doca_buf_dec_refcount(ALL::SOURCE_BUF)
        if REMAINING_TASKS == 0 {
            for i : ALL::CONNECTIONS {
                doca_rdma_connection_disconnect(ALL::CONNECTIONS[i])
            }
            doca_ctx_stop(ALL::RDMA_CTX)
        }

    rdma_write_requester_error_callback(TASK_WRITE, TASK_USER_DATA, CTX_USER_DATA):

        ALL = CTX_USER_DATA
        ERROR = TASK_USER_DATA
        RDMA_TASK = doca_rdma_task_send_as_task(TASK_WRITE)
        doca_task_get_status(RDMA_TASK)        
        doca_buf_dec_refcount(ALL::DEST_BUF)
        doca_buf_dec_refcount(ALL::SOURCE_BUF)
        doca_task_free(RDMA_TASK)
        if REMAINING_TASKS == 0 {
            for i : ALL::CONNECTIONS {
                doca_rdma_connection_disconnect(ALL::CONNECTIONS[i])
            }
            doca_ctx_stop(ALL::RDMA_CTX)
        }


doca_ctx_set_state_changed_cb(RDMA_CTX, func{rdma_write_requester_state_change_callback})

    rdma_write_requester_state_change_callback(USER_DATA, CTX, CTX_PREV_STATE, CTX_NEXT_STATE):

        ALL = USER_DATA

        if CTX_NEXT_STATE == RUNNING {
            if SERVER {
                doca_rdma_start_listen_to_port(ALL::RDMA, PORT)
            }
            if CLIENT {
                CM_ADDRESS = doca_rdma_addr_create(ADDRESS_TYPE, ADRESS, PORT)
                CONNECTION_DATA = ALL
                doca_rdma_connect_to_addr(ALL::RDMA, CM_ADDRESS, CONNECTION_DATA)
            }
        }
        if CTX_NEXT_STATE == IDLE {
            ALL::RUN_PE = false
        }


BUF_INVENTORY = doca_buf_inventory_create(INITIAL_ELEMENTS_NUMBER)
doca_buf_inventory_start(BUF_INVENTORY)

REQUIRE_REMOTE_MMAP = true
IS_REQUESTER = true
NEED_SEND_TASK = false
NEED_RECEIVE_TASK = true

doca_rdma_task_receive_set_conf(RDMA, func{receive_task_completion_callback}, func{receive_task_error_callback})
    
    receive_task_completion_callback(TASK_RECEIVE, TASK_USER_DATA, CTX_USER_DATA):

        DEST_BUF = doca_rdma_task_receive_get_dst_buf(TASK_RECEIVE)
        ALL = CTX_USER_DATA

        DEST_BUF_LEN = doca_buf_get_data_len(DEST_BUF)
        RDMA_TASK = doca_rdma_task_receive_as_task(TASK_RECEIVE)
        doca_task_free(RDMA_TASK)
        doca_buf_dec_refcount(DEST_BUF)

        ALL::REMOTE_MMAP_DESCRIPTOR_SIZE = DEST_BUF_LEN


        --- [create_and_submit_write_task] -----------------

        REMOTE_MMAP = doca_mmap_create_from_export(USER_DATA = NULL, ALL::REMOTE_MMAP_DESCRIPTOR,
                                                   ALL::REMOTE_MMAP_DESCRIPTOR_SIZE, ALL::DEVICE)
        REMOTE_MEMRANGE = doca_mmap_get_memrange(REMOTE_MMAP)

        ALL::SOURCE_BUF = doca_buf_inventory_buf_get_by_data(ALL::BUF_INVENTORY, ALL::LOCAL_MMAP, ALL::LOCAL_MEMRANGE)
        SOURCE_BUF_DATA = doca_buf_get_data(SOURCE_BUF)

        strcpy("Hello", SOURCE_BUF_DATA)  

        ALL::DEST_BUF = doca_buf_inventory_buf_get_by_addr(ALL::BUF_INVENTORY, ALL::REMOTE_MMAP, ALL::REMOTE_MEMRANGE)
        TASK_USER_DATA = ALL::ERROR
        
        RDMA_WRITE_TASK = doca_rdma_task_write_allocate_init(ALL::RDMA, ALL::CONNECTIONS[0], 
                                                             ALL::SOURCE_BUF, ALL::DEST_BUF, TASK_USER_DATA)
        doca_task_submit(RDMA_WRITE_TASK)

        ----------------------------------------------------

    receive_task_error_callback(TASK_RECEIVE, TASK_USER_DATA, CTX_USER_DATA):

        ALL = CTX_USER_DATA
        RDMA_TASK = doca_rdma_task_receive_as_task(TASK_RECEIVE)
        doca_task_get_status(RDMA_TASK)   
        doca_task_free(RECEIVE_TASK) 

        BUF = doca_rdma_task_receive_get_dst_buf(RECEIVE_TASK)
        doca_buf_dec_refcount(BUF)
        doca_ctx_stop(RDMA_CTX)



doca_rdma_set_connection_state_callbacks(
    RDMA,
    func{rdma_cm_connect_request_cb},
    func{rdma_cm_connect_established_cb},
    func{rdma_cm_connect_failure_cb},
    func{rdma_cm_disconnect_cb},
)
    rdma_cm_connect_request_cb(RDMA_CONNECTION, CTX_USER_DATA):

        ALL = CTX_USER_DATA
        doca_rdma_connection_accept(RDMA_CONNECTION)
        doca_rdma_connection_set_user_data(RDMA_CONNECTION, CTX_USER_DATA)

    rdma_cm_connect_established_cb(RDMA_CONNECTION, CONNECTION_USER_DATA, CTX_USER_DATA):

        ALL = CTX_USER_DATA
        CONNECTION_DATA = CONNECTION_INDEX = 0
        doca_rdma_connection_set_user_data(RDMA_CONNECTION, CONNECTION_DATA)
        ALL::CONNECTIONS[CONNECTION_INDEX] = RDMA_CONNECTION

        --- [rdma_requester_recv_data_from_rdma_responder] ------------------

        RECEIVE_DESCRIPTOR = malloc()

        RECEIVE_DESCRIPTOR_MMAP = doca_mmap_create()
        doca_mmap_set_permissions(RECEIVE_DESCRIPTOR_MMAP, DOCA_ACCESS_FLAG_LOCAL_READ_WRITE)
        doca_mmap_set_memrange(RECEIVE_DESCRIPTOR_MMAP, RECEIVE_DESCRIPTOR)
        doca_mmap_add_dev(RECEIVE_DESCRIPTOR_MMAP, ALL::DEVICE)
        doca_mmap_start(RECEIVE_DESCRIPTOR_MMAP)

        DESCRIPTOR_BUF = doca_buf_inventory_buf_get_by_addr(ALL::BUF_INVENTORY, RECEIVE_DESCRIPTOR_MMAP, RECEIVE_DESCRIPTOR)
        TASK_USER_DATA = ALL
        RECEIVE_TASK = doca_rdma_task_receive_allocate_init(ALL::RDMA, DESCRIPTOR_BUF, TASK_USER_DATA)
        RDMA_TASK = doca_rdma_task_receive_as_task(RECEIVE_TASK)
        doca_task_submit(RDMA_TASK)

        ALL::REMOTE_MMAP_DESCRIPTOR = RECEIVE_DESCRIPTOR
        ALL::REMOTE_MMAP_DESCRIPTOR_MMAP = RECEIVE_DESCRIPTOR_MMAP

        ---------------------------------------------------------------------

    rdma_cm_connect_failure_cb(RDMA_CONNECTION, CONNECTION_USER_DATA, CTX_USER_DATA): 

        CONNECTION_INDEX = CONNECTION_USER_DATA
        ALL = CTX_USER_DATA
        -rm ALL::CONNECTIONS[CONNECTION_INDEX]
        ALL::RUN_PE = false

    rdma_cm_disconnect_cb(RDMA_CONNECTION, CONNECTION_USER_DATA, CTX_USER_DATA):

        CONNECTION_INDEX = CONNECTION_USER_DATA
        ALL = CTX_USER_DATA
        doca_rdma_connection_disconnect(RDMA_CONNECTION)
        -rm ALL::CONNECTIONS[CONNECTION_INDEX]


CTX_USER_DATA = ALL
doca_ctx_set_user_data(RDMA_CTX, CTX_USER_DATA)
doca_ctx_start(RDMA_CTX)

while RUN_PE {
    doca_pe_progress(PE)
}



----------------

doca_buf_inventory_stop
doca_buf_inventory_destroy

doca_ctx_get_state
doca_ctx_stop

doca_mmap_stop
doca_mmap_destroy

doca_rdma_addr_destroy
doca_mmap_destroy
doca_mmap_destroy
doca_mmap_destroy

doca_rdma_destroy
doca_pe_destroy
doca_mmap_stop
doca_mmap_destroy

doca_dev_close





