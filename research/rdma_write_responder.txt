Config 
============
Peers: 
    WriteResponder <- WriteRequester

Connections:
    CM
====================================


DEV_LIST = doca_devinfo_create_list()
for dev_ib_name != input_ib_name {
    dev_ib_name = doca_devinfo_get_ibdev_name(DEV_LIST[i])
    DEVICE = doca_dev_open(DEV_LIST[i])
}
doca_devinfo_destroy_list(DEV_LIST)

LOCAL_MEMRANGE = calloc()    // 4096 bytes

[create_local_mmap]
LOCAL_MMAP = doca_mmap_create()
doca_mmap_set_permissions(LOCAL_MMAP, localReadWrite | rdmaWrite)
doca_mmap_set_LOCAL_memrange(LOCAL_MMAP, LOCAL_MEMRANGE)
doca_mmap_add_dev(LOCAL_MMAP, DEVICE)
doca_mmap_start(LOCAL_MMAP)

PE = doca_pe_create()

RDMA = doca_rdma_create(DEVICE)
RDMA_CTX = doca_rdma_as_ctx(RDMA)
doca_rdma_set_permissions(RDMA, rdmaWrite)
doca_rdma_set_gid_index(RDMA)
doca_rdma_set_max_num_connections(RDMA, NUM_CONNECTIONS)
doca_rdma_set_transport_type(RDMA, CM)

doca_pe_connect_ctx(PE, RDMA_CTX)

doca_ctx_set_state_changed_cb(RDMA_CTX, func{rdma_write_responder_state_change_callback})

    rdma_write_responder_state_change_callback:
        if CTX == RUNNING {
            if SERVER {
                doca_rdma_start_listen_to_port(RDMA)
            }
            if CLIENT {
                ADDR = doca_rdma_addr_create()
                doca_rdma_connect_to_addr(ADDR)
            }
        }
        if CTX == IDLE {
            RUN_PE = false
        }


REQUIRE_REMOTE_MMAP = true
IS_REQUESTER = false

doca_rdma_task_send_set_conf(RDMA, func{SEND_task_completion_callback}, func{SEND_task_error_callback})
    
    SEND_task_completion_callback:
        SEND_TASK = doca_rdma_task_send_as_task(SEND_TASK)
        doca_task_free(SEND_TASK)
        strcpy(BUFFER, LOCAL_MMAP_MEMRANGE)
        doca_rdma_connection_disconnect(RDMA_CONNECTION)
        doca_ctx_stop(RDMA_CTX)

    SEND_task_error_callback:
        SEND_TASK = doca_rdma_task_send_as_task(SEND_TASK)
        doca_task_free(SEND_TASK)
        SOURCE_BUF = doca_rdma_task_send_get_dst_buf(SEND_TASK)
        doca_buf_dec_refcount(SOURCE_BUF)
        doca_ctx_stop(RDMA_CTX)



doca_rdma_set_connection_state_callbacks(
    RDMA,
    func{rdma_cm_connect_request_cb},
    func{rdma_cm_connect_established_cb},
    func{rdma_cm_connect_failure_cb},
    func{rdma_cm_disconnect_cb},
)
    rdma_cm_connect_request_cb:
        doca_rdma_connection_accept(RDMA_CONNECTION)

    rdma_cm_connect_established_cb:
        if RECEIVE_SYNC_EVENT_DESC {
            SYNC_EVENT_DESC = doca_sync_event_export_to_remote_net(SYNC_EVENT)
            SEND_DESC = SYNC_EVENT_DESC
        }
        else {
            MMAP_DESCRIPTOR = doca_mmap_export_rdma(LOCAL_MMAP, DEVICE)
            SEND_DESC = MMAP_DESCRIPTOR
        }

        BUFF_INVENTORY = doca_buf_inventory_create()
        doca_buf_inventory_start(BUFF_INVENTORY)
        SEND_DESC_MMAP = create_local_mmap(MMAP_DESCRIPTOR, localReadWrite, SEND_DESC)
        SYNC_EVENT_DESC_MMAP = SEND_DESC_MMAP

        SRC_BUF = doca_buf_inventory_buf_get_by_data()
        RDMA_SEND_TASK = doca_rdma_task_send_allocate_init()
        DESC_BUF = doca_buf_inventory_buf_get_by_data(BUFF_INVENTORY, SEND_DESC_MMAP, SEND_DESC)
        SEND_TASK = doca_rdma_task_receive_allocate_init(RDMA, DESC_BUF)
        doca_task_submit(SEND_TASK)

    rdma_cm_connect_failure_cb: 
        RUN_PE = false

    rdma_cm_disconnect_cb
        doca_rdma_connection_disconnect(RDMA_CONNECTION)


doca_ctx_start(RDMA_CTX)
while RUN_PE {
    doca_pe_progress(PE)
}



----------------

doca_buf_inventory_stop
doca_buf_inventory_destroy

doca_ctx_get_state
doca_ctx_stop

doca_mmap_stop
doca_mmap_destroy

doca_rdma_addr_destroy
doca_mmap_destroy
doca_mmap_destroy
doca_mmap_destroy

doca_rdma_destroy
doca_pe_destroy
doca_mmap_stop
doca_mmap_destroy

doca_dev_close





